#!/bin/bash
# ============================================================================
# GLM_quota_kicker - ä¸»å‘½ä»¤å…¥å£
# ============================================================================
# åŠŸèƒ½ï¼šç»Ÿä¸€å‘½ä»¤å…¥å£ï¼Œå¤„ç†æ‰€æœ‰ç”¨æˆ·æ“ä½œ
# ============================================================================

set -euo pipefail

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# åŠ è½½æ‰€æœ‰æ¨¡å—
source "$SCRIPT_DIR/lib/deps.sh"
source "$SCRIPT_DIR/lib/logger.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/utils.sh"
source "$SCRIPT_DIR/lib/quota.sh"
source "$SCRIPT_DIR/lib/api.sh"
source "$SCRIPT_DIR/lib/scheduler.sh"
source "$SCRIPT_DIR/lib/timer.sh"
source "$SCRIPT_DIR/lib/awake.sh"

# ============================================================================
# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
# ============================================================================
show_help() {
    cat << EOF
${GREEN}GLM_quota_kicker${NC} - AI API é…é¢å”¤é†’å·¥å…·

${BLUE}ç”¨æ³•:${NC}
    $(basename "$0") [é€‰é¡¹]

${BLUE}é€‰é¡¹:${NC}
    -h, --help              æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
    -q, --quota             æ™ºèƒ½é…é¢ç®¡ç†ï¼ˆæŸ¥è¯¢+æ¿€æ´»/è°ƒåº¦ï¼‰
    -v, --version           æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    -a, --awake [CMD]       é˜²ç¡çœ æ§åˆ¶ï¼ˆä»… macOSï¼‰
                            CMD: start|stop|status|restart
                            å¯ä¸å…¶ä»–é€‰é¡¹ç»„åˆä½¿ç”¨
    -d, --daemon TIME       åå°å®šæ—¶æ¨¡å¼ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
                            æ ¼å¼: HH:MM:SSã€HHMMSSã€HH:MM æˆ– HHMM
    -s, --setup             é‡æ–°é…ç½®

${BLUE}å­å‘½ä»¤:${NC}
    ./bin/check-quota       æ£€æŸ¥é…é¢çŠ¶æ€
    ./bin/send-request      å‘é€å”¤é†’è¯·æ±‚
    ./bin/schedule-task     ç®¡ç†è°ƒåº¦ä»»åŠ¡

${BLUE}é…ç½®æ–‡ä»¶:${NC}
    $(config_path)

${BLUE}æ—¥å¿—æ–‡ä»¶:${NC}
    $(log_path)

${BLUE}ç¤ºä¾‹:${NC}
    # æ™ºèƒ½é…é¢ç®¡ç†ï¼ˆæ¨èï¼‰
    ./wake.sh -q

    # ç›´æ¥å”¤é†’
    ./wake.sh

    # åå°å®šæ—¶æ‰§è¡Œï¼ˆé«˜çº§ç”¨æ³•ï¼‰
    ./wake.sh -d 15:14

    # å¯åŠ¨é˜²ç¡çœ  + åå°å®šæ—¶
    ./wake.sh -a -d 15:14

    # é‡æ–°é…ç½®
    ./wake.sh -s

${BLUE}æç¤º:${NC}
    å¦‚æœå·²å°†è„šæœ¬æ·»åŠ åˆ° PATHï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨: wake

æ›´å¤šä¿¡æ¯è¯·è®¿é—®: https://github.com/ssdiwu/GLM_quota_kicker
EOF
}

# ============================================================================
# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
# ============================================================================
show_version() {
    echo "GLM_quota_kicker v0.5.0 (æ¨¡å—åŒ–ç‰ˆæœ¬)"
    echo "Copyright (c) 2025 GLM_quota_kicker contributors"
    echo "MIT License"
}

# ============================================================================
# é…ç½®å‘å¯¼
# ============================================================================
run_setup_wizard() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘     GLM_quota_kicker é…ç½®å‘å¯¼            â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    # å›ºå®šä½¿ç”¨æ™ºè°± AI
    local provider_name="æ™ºè°± AI"
    local base_url="https://open.bigmodel.cn/api/anthropic"
    local endpoint="/v1/messages"
    local auth_header="x-api-key"

    echo -e "${GREEN}æœåŠ¡å•†: æ™ºè°± AI${NC}"
    echo

    # è¾“å…¥ API Key
    echo -n "è¯·è¾“å…¥ API Key: "
    read -rs api_key
    echo

    if [[ -z "$api_key" ]]; then
        log_error_exit "API Key ä¸èƒ½ä¸ºç©º"
    fi

    # è¾“å…¥æ¨¡å‹åç§°
    echo -e "${CYAN}è¯·è¾“å…¥æ¨¡å‹åç§°${NC} ${YELLOW}[é»˜è®¤: glm-4.7]${NC}"
    echo -e "  ${GRAY}å¦‚æœä¸æ¸…æ¥šä¸éœ€è¦å¡«å†™ï¼Œç›´æ¥å›è½¦ï¼${NC}"
    echo -n "æ¨¡å‹åç§°: "
    read -r model
    model="${model:-glm-4.7}"

    echo
    echo -e "${GREEN}é…ç½®æ‘˜è¦:${NC}"
    echo "  æœåŠ¡å•†: $provider_name"
    echo "  æ¨¡å‹: $model"
    echo

    echo -n "ç¡®è®¤å¹¶åˆ›å»ºé…ç½®æ–‡ä»¶? [Y/n]: "
    read -r confirm
    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        echo "å·²å–æ¶ˆ"
        exit 0
    fi

    # åˆ›å»ºé…ç½®æ–‡ä»¶
    cat > "$(config_path)" << EOF
{
  "api": {
    "key": "$api_key",
    "model": "$model"
  },
  "provider": {
    "name": "$provider_name",
    "baseUrl": "$base_url",
    "endpoint": "$endpoint",
    "authHeader": "$auth_header"
  },
  "request": {
    "prompts": [
      "hi",
      "ä½ å¥½",
      "hello",
      "æ—©ä¸Šå¥½",
      "åœ¨å—",
      "æµ‹è¯•è¿æ¥",
      "ping",
      "1+1ç­‰äºå‡ ",
      "ç°åœ¨å‡ ç‚¹äº†",
      "å¤©æ°”æ€ä¹ˆæ ·"
    ]
  }
}
EOF

    echo
    log_success "é…ç½®æ–‡ä»¶å·²åˆ›å»º"
    echo -e "${CYAN}ğŸ’¡ ä½¿ç”¨æç¤º:${NC}"
    echo -e "  ${GRAY}â€¢${NC} è¿è¡Œ ${GREEN}./wake.sh -q${NC} æŸ¥è¯¢é…é¢ä½¿ç”¨æƒ…å†µ"
    echo -e "  ${GRAY}â€¢${NC} è¿è¡Œ ${GREEN}./wake.sh -Q${NC} æŸ¥è¯¢é…é¢å¹¶è‡ªåŠ¨è®¾ç½®å”¤é†’"
}

# ============================================================================
# ä¸»å‡½æ•°
# ============================================================================
main() {
    # æ£€æŸ¥ä¾èµ–
    dep_check_required || exit 1

    local quota_mode=false
    local setup_mode=false
    local daemon_time=""
    local awake_mode=false
    local awake_cmd=""

    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -q|--quota)
                quota_mode=true
                shift
                ;;
            -a|--awake)
                awake_mode=true
                if [[ "${2:-}" =~ ^(start|stop|status|restart)$ ]]; then
                    awake_cmd="$2"
                    shift 2
                else
                    awake_cmd="start"
                    shift
                fi
                ;;
            -s|--setup)
                setup_mode=true
                shift
                ;;
            -d|--daemon)
                daemon_time="$2"
                shift 2
                ;;
            *)
                echo -e "${RED}æœªçŸ¥é€‰é¡¹: $1${NC}" >&2
                show_help
                exit 1
                ;;
        esac
    done

    # å¤„ç†é˜²ç¡çœ å‘½ä»¤ï¼ˆçº¯å‘½ä»¤æ¨¡å¼ï¼‰
    if [[ "$awake_mode" == true && -z "$daemon_time" && "$setup_mode" == false && "$quota_mode" == false ]]; then
        case "$awake_cmd" in
            start)
                awake_start
                ;;
            stop)
                awake_stop
                ;;
            status|--status)
                awake_status
                ;;
            restart)
                awake_restart
                ;;
        esac
        exit 0
    fi

    # é…é¢æ™ºèƒ½ç®¡ç†æ¨¡å¼
    if [[ "$quota_mode" == true ]]; then
        if ! config_exists; then
            echo -e "${RED}é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨${NC}" >&2
            echo -e "${CYAN}æç¤º: è¯·å…ˆè¿è¡Œ ./wake.sh -s è¿›è¡Œé…ç½®${NC}"
            exit 1
        fi

        config_load || { echo -e "${RED}é…ç½®åŠ è½½å¤±è´¥${NC}" >&2; exit 1; }
        config_validate || { echo -e "${RED}é…ç½®éªŒè¯å¤±è´¥${NC}" >&2; exit 1; }

        if quota_query; then
            quota_format_display

            local usage_percent="${QUOTA_PERCENTAGE:-0}"
            local has_reset_time="${QUOTA_RESET_TIME:-}"

            # åœºæ™¯1: é…é¢æœªæ¿€æ´»ï¼ˆ< 5% ä¸”æ— é‡ç½®æ—¶é—´ï¼‰
            if [[ "$usage_percent" -lt 5 ]] && [[ -z "$has_reset_time" || "$has_reset_time" == "null" ]]; then
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${YELLOW}ğŸ’¡ æ£€æµ‹åˆ°é…é¢æœªæ¿€æ´»ï¼ˆä½¿ç”¨ç‡: ${usage_percent}%ï¼‰${NC}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -n "æ˜¯å¦ç«‹å³æ‰§è¡Œä¸€æ¬¡æ¿€æ´»ï¼Ÿ[Y/n]: "
                read -r confirm
                if [[ ! "$confirm" =~ ^[Nn]$ ]]; then
                    echo -e "${CYAN}æ­£åœ¨æ¿€æ´»é…é¢...${NC}"
                    api_set_prompt
                    if api_send_request; then
                        echo -e "${GREEN}âœ“ é…é¢æ¿€æ´»æˆåŠŸï¼${NC}"
                    else
                        echo -e "${RED}âœ— æ¿€æ´»å¤±è´¥${NC}" >&2
                        exit 1
                    fi
                fi

            # åœºæ™¯2: æœ‰é‡ç½®æ—¶é—´ï¼ˆä»»ä½•ä½¿ç”¨ç‡ï¼Œåªè¦æœ‰é‡ç½®æ—¶é—´å°±æç¤ºè‡ªåŠ¨å”¤é†’ï¼‰
            elif [[ -n "$has_reset_time" && "$has_reset_time" != "null" ]]; then
                local reset_str
                reset_str=$(quota_format_reset_time "$has_reset_time")
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${YELLOW}â° é…é¢å°†åœ¨ ${reset_str} é‡ç½®${NC}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»»åŠ¡
                quota_check_existing_task
                local check_result=$?

                if [[ $check_result -eq 0 ]]; then
                    # ä»»åŠ¡å·²å­˜åœ¨
                    local wait_str
                    if [[ -n "${AUTO_WAIT_SECONDS:-}" ]]; then
                        wait_str=$(utils_format_seconds "$AUTO_WAIT_SECONDS")
                    else
                        wait_str="æœªçŸ¥æ—¶é—´"
                    fi

                    echo -e "${GREEN}âœ“ è‡ªåŠ¨å”¤é†’ä»»åŠ¡å·²è¿è¡Œ${NC}"
                    echo -e "${GRAY}  PID: ${AUTO_WAKE_PID}${NC}"
                    echo -e "${GRAY}  å‰©ä½™ç­‰å¾…: ${wait_str}${NC}"
                    echo
                    echo -n "æ˜¯å¦é‡æ–°è®¾ç½®ä»»åŠ¡ï¼Ÿ[y/N]: "
                    read -r confirm
                    if [[ "$confirm" =~ ^[Yy]$ ]]; then
                        # å…ˆåœæ­¢æ—§ä»»åŠ¡
                        kill "${AUTO_WAKE_PID}" 2>/dev/null || true
                        rm -f "$CONFIG_DIR/.auto_wake.pid" "$CONFIG_DIR/.auto_wake_${AUTO_WAKE_PID}.sh"
                        if quota_schedule_auto_wake; then
                            quota_format_schedule_info
                            echo -e "${GREEN}âœ“ è‡ªåŠ¨å”¤é†’ä»»åŠ¡å·²é‡æ–°è®¾ç½®${NC}"
                        else
                            echo -e "${YELLOW}âš  æ— æ³•åˆ›å»ºè‡ªåŠ¨è°ƒåº¦ä»»åŠ¡${NC}" >&2
                        fi
                    fi
                else
                    # æ²¡æœ‰ä»»åŠ¡ï¼Œè¯¢é—®æ˜¯å¦åˆ›å»º
                    echo -n "æ˜¯å¦è®¾ç½®è‡ªåŠ¨å”¤é†’ä»»åŠ¡ï¼Ÿ[Y/n]: "
                    read -r confirm
                    if [[ ! "$confirm" =~ ^[Nn]$ ]]; then
                        if quota_schedule_auto_wake; then
                            quota_format_schedule_info
                            echo -e "${GREEN}âœ“ è‡ªåŠ¨å”¤é†’ä»»åŠ¡å·²è®¾ç½®${NC}"
                        else
                            echo -e "${YELLOW}âš  æ— æ³•åˆ›å»ºè‡ªåŠ¨è°ƒåº¦ä»»åŠ¡${NC}" >&2
                        fi
                    fi
                fi

            # åœºæ™¯3: æ— é‡ç½®æ—¶é—´ä¸”é…é¢æ­£å¸¸
            else
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${GREEN}ğŸ’¡ é…é¢çŠ¶æ€æ­£å¸¸${NC}"
                echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
                echo -e "${GRAY}æç¤º:${NC}"
                echo -e "  ${GRAY}â€¢${NC} é…é¢æœ‰é‡ç½®æ—¶é—´åå¯è¿è¡Œ ${GREEN}./wake.sh -q${NC} è®¾ç½®è‡ªåŠ¨å”¤é†’"
            fi

            exit 0
        else
            echo -e "${RED}é…é¢æŸ¥è¯¢å¤±è´¥${NC}" >&2
            echo -e "${CYAN}æç¤º: è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ API Key${NC}"
            exit 1
        fi
    fi

    # é…ç½®å‘å¯¼
    if [[ "$setup_mode" == true ]]; then
        run_setup_wizard
        exit 0
    fi

    # åå°å®šæ—¶æ¨¡å¼
    if [[ -n "$daemon_time" ]]; then
        if [[ "$awake_mode" == true ]]; then
            awake_start
            echo
        fi
        timer_run_background "$daemon_time"
        exit 0
    fi

    # é»˜è®¤ï¼šåŠ è½½é…ç½®å¹¶å‘é€è¯·æ±‚
    if ! config_exists; then
        run_setup_wizard
        exit 0
    fi

    config_load || log_error_exit "é…ç½®åŠ è½½å¤±è´¥"
    config_validate || log_error_exit "é…ç½®éªŒè¯å¤±è´¥"
    api_set_prompt

    # å‘é€è¯·æ±‚
    api_send_request
    local result=$?

    # å¦‚æœæ˜¯ 1308 é”™è¯¯ï¼Œåˆ›å»ºé‡è¯•ä»»åŠ¡
    if [[ $result -eq 2 && -n "${API_RESET_TIME:-}" ]]; then
        log_info "æ£€æµ‹åˆ° 1308 é”™è¯¯ï¼Œå‡†å¤‡åˆ›å»ºé‡è¯•ä»»åŠ¡ï¼Œé‡ç½®æ—¶é—´: $API_RESET_TIME"
        scheduler_create_retry_task "$API_RESET_TIME"
        local retry_result=$?
        if [[ $retry_result -eq 0 ]]; then
            log_info "é‡è¯•ä»»åŠ¡åˆ›å»ºæˆåŠŸ"
        else
            log_error "é‡è¯•ä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼Œé”™è¯¯ç : $retry_result"
        fi
    elif [[ $result -eq 2 ]]; then
        log_warn "æ”¶åˆ° 1308 é”™è¯¯ï¼Œä½† API_RESET_TIME å˜é‡ä¸ºç©º"
    fi

    exit $result
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
