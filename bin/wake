#!/bin/bash
# ============================================================================
# GLM_quota_kicker - ä¸»å‘½ä»¤å…¥å£
# ============================================================================
# åŠŸèƒ½ï¼šç»Ÿä¸€å‘½ä»¤å…¥å£ï¼Œå¤„ç†æ‰€æœ‰ç”¨æˆ·æ“ä½œ
# ============================================================================

set -euo pipefail

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# åŠ è½½æ‰€æœ‰æ¨¡å—
source "$SCRIPT_DIR/lib/deps.sh"
source "$SCRIPT_DIR/lib/logger.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/utils.sh"
source "$SCRIPT_DIR/lib/api.sh"
source "$SCRIPT_DIR/lib/scheduler.sh"
source "$SCRIPT_DIR/lib/timer.sh"
source "$SCRIPT_DIR/lib/awake.sh"

# ============================================================================
# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
# ============================================================================
show_help() {
    cat << EOF
${GREEN}GLM_quota_kicker${NC} - AI API é…é¢å”¤é†’å·¥å…·

${BLUE}ç”¨æ³•:${NC}
    $(basename "$0") [é€‰é¡¹]

${BLUE}é€‰é¡¹:${NC}
    -h, --help              æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
    -t, --test              æµ‹è¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼‰
    -v, --version           æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    -a, --awake [CMD]       é˜²ç¡çœ æ§åˆ¶ï¼ˆä»… macOSï¼‰
                            CMD: start|stop|status|restart
                            å¯ä¸å…¶ä»–é€‰é¡¹ç»„åˆä½¿ç”¨
    -T, --timer TIME        åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œï¼ˆæ ¼å¼ï¼šHH:MM:SSã€HHMMSSã€HH:MM æˆ– HHMMï¼‰
    -d, --daemon TIME       åå°å®šæ—¶æ¨¡å¼ï¼ˆæ ¼å¼ï¼šHH:MM:SSã€HHMMSSã€HH:MM æˆ– HHMMï¼‰
    -s, --setup             é‡æ–°é…ç½®è°ƒåº¦
    -u, --unschedule        å–æ¶ˆè°ƒåº¦

${BLUE}å­å‘½ä»¤:${NC}
    ./bin/check-quota       æ£€æŸ¥é…é¢çŠ¶æ€
    ./bin/send-request      å‘é€å”¤é†’è¯·æ±‚
    ./bin/schedule-task     ç®¡ç†è°ƒåº¦ä»»åŠ¡

${BLUE}é…ç½®æ–‡ä»¶:${NC}
    $(config_path)

${BLUE}æ—¥å¿—æ–‡ä»¶:${NC}
    $(log_path)

${BLUE}ç¤ºä¾‹:${NC}
    # æµ‹è¯•é…ç½®
    ./wake.sh -t

    # åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œï¼ˆå‰å°ï¼‰
    ./wake.sh -T 15:14

    # åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œï¼ˆåå°ï¼‰
    ./wake.sh -d 1514

    # å¯åŠ¨é˜²ç¡çœ  + åå°å®šæ—¶
    ./wake.sh -a -d 15:14

    # é‡æ–°é…ç½®
    ./wake.sh -s

${BLUE}æç¤º:${NC}
    å¦‚æœå·²å°†è„šæœ¬æ·»åŠ åˆ° PATHï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨:
    wake -t

æ›´å¤šä¿¡æ¯è¯·è®¿é—®: https://github.com/ssdiwu/GLM_quota_kicker
EOF
}

# ============================================================================
# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
# ============================================================================
show_version() {
    echo "GLM_quota_kicker v0.5.0 (æ¨¡å—åŒ–ç‰ˆæœ¬)"
    echo "Copyright (c) 2025 GLM_quota_kicker contributors"
    echo "MIT License"
}

# ============================================================================
# é…ç½®å‘å¯¼
# ============================================================================
run_setup_wizard() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘     GLM_quota_kicker é…ç½®å‘å¯¼            â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo

    # å›ºå®šä½¿ç”¨æ™ºè°± AI
    local provider_name="æ™ºè°± AI"
    local base_url="https://open.bigmodel.cn/api/anthropic"
    local endpoint="/v1/messages"
    local auth_header="x-api-key"

    echo -e "${GREEN}æœåŠ¡å•†: æ™ºè°± AI${NC}"
    echo

    # è¾“å…¥ API Key
    echo -n "è¯·è¾“å…¥ API Key: "
    read -rs api_key
    echo

    if [[ -z "$api_key" ]]; then
        log_error_exit "API Key ä¸èƒ½ä¸ºç©º"
    fi

    # è¾“å…¥æ¨¡å‹åç§°
    echo -e "${CYAN}è¯·è¾“å…¥æ¨¡å‹åç§°${NC} ${YELLOW}[é»˜è®¤: glm-4.7]${NC}"
    echo -e "  ${GRAY}å¦‚æœä¸æ¸…æ¥šä¸éœ€è¦å¡«å†™ï¼Œç›´æ¥å›è½¦ï¼${NC}"
    echo -n "æ¨¡å‹åç§°: "
    read -r model
    model="${model:-glm-4.7}"

    echo

    # è®¾ç½®è°ƒåº¦æ—¶é—´
    echo -e "${YELLOW}è¯·è®¾ç½®å”¤é†’æ—¶é—´ï¼ˆæœ€å¤š 4 ä¸ªï¼Œå¯¹åº”é…é¢é‡ç½®å‘¨æœŸï¼‰:${NC}"
    echo "æ™ºè°± AI é…é¢æ¯ 5 å°æ—¶é‡ç½®ï¼š00:00 â†’ 05:00 â†’ 10:00 â†’ 15:00 â†’ 20:00"
    echo "è¾“å…¥ç¬¬ä¸€ä¸ªæ—¶é—´åï¼Œåç»­æ—¶é—´å°†è‡ªåŠ¨æŒ‰ 5 å°æ—¶é€’å¢"
    echo "æ”¯æŒæ ¼å¼ï¼šHH:MM æˆ– HHMMï¼ˆå¦‚ 06:00 æˆ– 0600ï¼‰"
    echo

    local -a schedule_times=()
    local first_time="06:00"
    local prev_time=""

    for i in 1 2 3 4; do
        local default_time="$first_time"
        local hint="[é»˜è®¤: $default_time]"

        if [[ $i -gt 1 && -n "$prev_time" ]]; then
            local calculated_time
            calculated_time=$(utils_calculate_next_time "$prev_time" 5)
            if [[ -n "$calculated_time" ]]; then
                default_time="$calculated_time"
            fi
            hint="[é»˜è®¤: $default_time, åŸºäºä¸Šä¸€ä¸ªæ—¶é—´+5å°æ—¶]"
        fi

        echo -n "æ—¶é—´ $i $hint: "
        read -r time_input

        # å»é™¤é¦–å°¾ç©ºæ ¼
        time_input="${time_input// /}"

        # å¦‚æœç”¨æˆ·ç›´æ¥å›è½¦ï¼Œä½¿ç”¨é»˜è®¤å€¼
        if [[ -z "$time_input" ]]; then
            time_input="$default_time"
        fi

        # è§„èŒƒåŒ–æ—¶é—´æ ¼å¼
        if [[ "$time_input" =~ ^([0-1][0-9]|2[0-3])([0-5][0-9])$ ]]; then
            time_input="${BASH_REMATCH[1]}:${BASH_REMATCH[2]}"
        fi

        # éªŒè¯æ—¶é—´æ ¼å¼
        if [[ ! "$time_input" =~ ^([0-1][0-9]|2[0-3]):[0-5][0-9]$ ]]; then
            echo -e "${RED}æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼: $default_time${NC}"
            time_input="$default_time"
        fi

        schedule_times+=("$time_input")
        prev_time="$time_input"
    done

    echo
    echo -e "${GREEN}é…ç½®æ‘˜è¦:${NC}"
    echo "  æœåŠ¡å•†: $provider_name"
    echo "  æ¨¡å‹: $model"
    echo "  å”¤é†’æ—¶é—´: ${schedule_times[*]}"
    echo

    echo -n "ç¡®è®¤å¹¶åˆ›å»ºé…ç½®æ–‡ä»¶? [Y/n]: "
    read -r confirm
    if [[ "$confirm" =~ ^[Nn]$ ]]; then
        echo "å·²å–æ¶ˆ"
        exit 0
    fi

    # åˆ›å»ºé…ç½®æ–‡ä»¶
    local schedule_json="["
    local first=true
    for t in "${schedule_times[@]}"; do
        if [[ "$first" == true ]]; then
            schedule_json+="\"$t\""
            first=false
        else
            schedule_json+=", \"$t\""
        fi
    done
    schedule_json+="]"

    cat > "$(config_path)" << EOF
{
  "api": {
    "key": "$api_key",
    "model": "$model"
  },
  "provider": {
    "name": "$provider_name",
    "baseUrl": "$base_url",
    "endpoint": "$endpoint",
    "authHeader": "$auth_header"
  },
  "schedule": $schedule_json,
  "request": {
    "prompts": [
      "hi",
      "ä½ å¥½",
      "hello",
      "æ—©ä¸Šå¥½",
      "åœ¨å—",
      "æµ‹è¯•è¿æ¥",
      "ping",
      "1+1ç­‰äºå‡ ",
      "ç°åœ¨å‡ ç‚¹äº†",
      "å¤©æ°”æ€ä¹ˆæ ·"
    ]
  }
}
EOF

    echo
    log_success "é…ç½®æ–‡ä»¶å·²åˆ›å»º"
    echo -e "${CYAN}ğŸ’¡ æç¤º: ä½ å¯ä»¥ç¼–è¾‘ config.jsonc æ¥è‡ªå®šä¹‰å”¤é†’æ¶ˆæ¯åˆ—è¡¨${NC}"

    # ç”Ÿæˆç³»ç»Ÿè°ƒåº¦
    scheduler_create "${schedule_times[@]}"
}

# ============================================================================
# æµ‹è¯•é…ç½®
# ============================================================================
test_configuration() {
    echo -e "${CYAN}æ­£åœ¨æµ‹è¯•é…ç½®...${NC}"
    echo

    # å…ˆåŠ è½½é…ç½®
    if ! config_load; then
        echo -e "${RED}âœ— é…ç½®åŠ è½½å¤±è´¥${NC}"
        return 1
    fi

    if ! config_validate; then
        echo -e "${RED}âœ— é…ç½®éªŒè¯å¤±è´¥${NC}"
        return 1
    fi

    # è®¾ç½®æ¶ˆæ¯
    if [[ "${HAS_CUSTOM_PROMPTS:-false}" == true && ${#PROMPTS_ARRAY[@]} -gt 0 ]]; then
        PROMPT=$(utils_random_choice PROMPTS_ARRAY)
        echo -e "${CYAN}ä½¿ç”¨è‡ªå®šä¹‰æ¶ˆæ¯: ${GRAY}$PROMPT${NC}"
    else
        PROMPT="${PROMPT:-hi}"
        echo -e "${CYAN}ä½¿ç”¨é»˜è®¤æ¶ˆæ¯: ${GRAY}$PROMPT${NC}"
    fi

    LOG_LEVEL="debug"
    api_send_request
    local result=$?

    echo
    if [[ $result -eq 0 ]]; then
        echo -e "${GREEN}âœ“ æµ‹è¯•æˆåŠŸï¼é…ç½®æ­£å¸¸å·¥ä½œ${NC}"
    elif [[ $result -eq 2 ]]; then
        echo -e "${YELLOW}âš  é…é¢ä¸è¶³ï¼ˆé”™è¯¯ç  1308ï¼‰${NC}"
        echo -e "${CYAN}â†’ å·²å®‰æ’åœ¨é…é¢é‡ç½®åè‡ªåŠ¨é‡è¯•${NC}"
    else
        echo -e "${RED}âœ— æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®${NC}"
        return 1
    fi
}

# ============================================================================
# ä¸»å‡½æ•°
# ============================================================================
main() {
    # æ£€æŸ¥ä¾èµ–
    dep_check_required || exit 1

    local test_mode=false
    local setup_mode=false
    local unschedule_mode=false
    local timer_time=""
    local daemon_time=""
    local awake_mode=false
    local awake_cmd=""

    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            -t|--test)
                test_mode=true
                shift
                ;;
            -a|--awake)
                awake_mode=true
                if [[ "${2:-}" =~ ^(start|stop|status|restart)$ ]]; then
                    awake_cmd="$2"
                    shift 2
                else
                    awake_cmd="start"
                    shift
                fi
                ;;
            -s|--setup)
                setup_mode=true
                shift
                ;;
            -u|--unschedule)
                unschedule_mode=true
                shift
                ;;
            -T|--timer)
                timer_time="$2"
                shift 2
                ;;
            -d|--daemon)
                daemon_time="$2"
                shift 2
                ;;
            *)
                echo -e "${RED}æœªçŸ¥é€‰é¡¹: $1${NC}" >&2
                show_help
                exit 1
                ;;
        esac
    done

    # å¤„ç†é˜²ç¡çœ å‘½ä»¤ï¼ˆçº¯å‘½ä»¤æ¨¡å¼ï¼‰
    if [[ "$awake_mode" == true && -z "$timer_time" && -z "$daemon_time" && "$setup_mode" == false && "$unschedule_mode" == false && "$test_mode" == false ]]; then
        case "$awake_cmd" in
            start)
                awake_start
                ;;
            stop)
                awake_stop
                ;;
            status|--status)
                awake_status
                ;;
            restart)
                awake_restart
                ;;
        esac
        exit 0
    fi

    # å–æ¶ˆè°ƒåº¦
    if [[ "$unschedule_mode" == true ]]; then
        scheduler_remove
        exit 0
    fi

    # é…ç½®å‘å¯¼
    if [[ "$setup_mode" == true ]]; then
        scheduler_remove
        run_setup_wizard
        test_configuration
        exit 0
    fi

    # å®šæ—¶å™¨æ¨¡å¼
    if [[ -n "$timer_time" ]]; then
        if [[ "$awake_mode" == true ]]; then
            awake_start
            echo
        fi
        timer_run_foreground "$timer_time"
        exit 0
    fi

    # åå°å®šæ—¶æ¨¡å¼
    if [[ -n "$daemon_time" ]]; then
        if [[ "$awake_mode" == true ]]; then
            awake_start
            echo
        fi
        timer_run_background "$daemon_time"
        exit 0
    fi

    # æµ‹è¯•æ¨¡å¼
    if [[ "$test_mode" == true ]]; then
        LOG_LEVEL="debug"
        echo -e "${BLUE}æµ‹è¯•æ¨¡å¼å·²å¯ç”¨${NC}\n"
        test_configuration
        exit 0
    fi

    # é»˜è®¤ï¼šåŠ è½½é…ç½®å¹¶å‘é€è¯·æ±‚
    if ! config_exists; then
        run_setup_wizard
        exit 0
    fi

    config_load || log_error_exit "é…ç½®åŠ è½½å¤±è´¥"
    config_validate || log_error_exit "é…ç½®éªŒè¯å¤±è´¥"
    api_set_prompt

    # å‘é€è¯·æ±‚
    api_send_request
    local result=$?

    # å¦‚æœæ˜¯ 1308 é”™è¯¯ï¼Œåˆ›å»ºé‡è¯•ä»»åŠ¡
    if [[ $result -eq 2 && -n "${API_RESET_TIME:-}" ]]; then
        scheduler_create_retry_task "$API_RESET_TIME"
    fi

    exit $result
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
