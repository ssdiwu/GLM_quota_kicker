#!/bin/bash
# ============================================================================
# GLM_quota_kicker - 调度任务管理命令
# ============================================================================
# 功能：管理系统调度任务（创建、删除、列出）
# ============================================================================

set -euo pipefail

# 获取脚本目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# 加载所有模块
source "$SCRIPT_DIR/lib/deps.sh"
source "$SCRIPT_DIR/lib/logger.sh"
source "$SCRIPT_DIR/lib/scheduler.sh"

# ============================================================================
# 显示帮助
# ============================================================================
show_help() {
    cat << EOF
${GREEN}GLM_quota_kicker - 调度任务管理${NC}

${BLUE}用法:${NC}
    $(basename "$0") <命令> [参数]

${BLUE}命令:${NC}
    create <时间>...    创建调度任务（支持 1-4 个时间）
    remove              删除所有调度任务
    list                列出当前调度任务

${BLUE}时间格式:${NC}
    HH:MM 或 HHMM（如：06:00 或 0600）

${BLUE}示例:${NC}
    ./bin/$(basename "$0") create 06:00 11:00 16:00 21:00
    ./bin/$(basename "$0") list
    ./bin/$(basename "$0") remove

EOF
}

# ============================================================================
# 创建调度任务
# ============================================================================
cmd_create() {
    if [[ $# -eq 0 ]]; then
        log_error "至少需要提供一个时间"
        echo "用法: $(basename "$0") create <时间>..."
        exit 1
    fi

    local -a times=()

    # 验证时间格式
    for time in "$@"; do
        # 规范化时间格式
        if [[ "$time" =~ ^([0-1][0-9]|2[0-3])([0-5][0-9])$ ]]; then
            time="${BASH_REMATCH[1]}:${BASH_REMATCH[2]}"
        fi

        # 验证时间格式
        if [[ ! "$time" =~ ^([0-1][0-9]|2[0-3]):[0-5][0-9]$ ]]; then
            log_error "时间格式无效: $1"
            echo "支持格式: HH:MM 或 HHMM（如 06:00 或 0600）"
            exit 1
        fi

        times+=("$time")
    done

    # 创建调度任务
    scheduler_create "${times[@]}"

    echo
    log_success "调度任务已创建"
    echo -e "${CYAN}配置的时间: ${times[*]}${NC}"
}

# ============================================================================
# 删除调度任务
# ============================================================================
cmd_remove() {
    scheduler_remove
    log_success "调度任务已删除"
}

# ============================================================================
# 列出调度任务
# ============================================================================
cmd_list() {
    scheduler_list
}

# ============================================================================
# 主函数
# ============================================================================
main() {
    # 检查依赖
    dep_check_required || exit 1

    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            cmd_create "$@"
            ;;
        remove)
            cmd_remove
            ;;
        list)
            cmd_list
            ;;
        -h|--help)
            show_help
            ;;
        *)
            echo -e "${RED}未知命令: $command${NC}" >&2
            show_help
            exit 1
            ;;
    esac
}

main "$@"
