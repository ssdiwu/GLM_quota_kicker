#!/bin/bash
# ============================================================================
# GLM_quota_kicker - 配额检查命令
# ============================================================================
# 功能：检查 API 配额状态
# ============================================================================

set -euo pipefail

# 获取脚本目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# 加载所有模块
source "$SCRIPT_DIR/lib/deps.sh"
source "$SCRIPT_DIR/lib/logger.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/quota.sh"

# ============================================================================
# 显示帮助
# ============================================================================
show_help() {
    cat << EOF
${GREEN}GLM_quota_kicker - 配额检查${NC}

${BLUE}用法:${NC}
    $(basename "$0") [选项]

${BLUE}选项:${NC}
    -h, --help          显示此帮助信息
    -v, --verbose       显示详细信息

${BLUE}示例:${NC}
    ./bin/$(basename "$0")           # 检查配额状态
    ./bin/$(basename "$0") -v        # 显示详细信息

EOF
}

# ============================================================================
# 主函数
# ============================================================================
main() {
    # 检查依赖
    dep_check_required || exit 1

    local verbose=false

    # 解析参数
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--verbose)
                verbose=true
                shift
                ;;
            *)
                echo -e "${RED}未知选项: $1${NC}" >&2
                show_help
                exit 1
                ;;
        esac
    done

    # 检查配置文件
    if ! config_exists; then
        log_error_exit "配置文件不存在，请先运行: bin/wake -s"
    fi

    # 加载配置
    config_load || log_error_exit "配置加载失败"
    config_validate || log_error_exit "配置验证失败"

    if [[ "$verbose" == true ]]; then
        LOG_LEVEL="debug"
    fi

    # 检查配额
    echo -e "${CYAN}正在检查配额状态...${NC}"
    echo

    if quota_query; then
        quota_format_display
        local usage_percent="${QUOTA_PERCENTAGE:-0}"
        if [[ "$usage_percent" -lt 100 ]]; then
            exit 0
        else
            exit 1
        fi
    else
        echo -e "${YELLOW}⚠ 配额查询失败${NC}"
        echo -e "${GRAY}请检查网络连接或 API Key${NC}"
        exit 1
    fi
}

main "$@"
