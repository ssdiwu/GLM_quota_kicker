#!/bin/bash
# ============================================================================
# GLM_quota_kicker - 依赖检查模块
# ============================================================================
# 功能：检查系统依赖和工具是否安装
# ============================================================================

# 防止重复加载
[[ -n "${_LIB_DEPS_LOADED:-}" ]] && return 0
_LIB_DEPS_LOADED=true

# 加载日志模块
source "$(dirname "${BASH_SOURCE[0]}")/logger.sh"

# ============================================================================
# 依赖列表
# ============================================================================
REQUIRED_TOOLS=("jq" "curl")
OPTIONAL_TOOLS=("caffeinate")

# ============================================================================
# 检查单个命令是否存在
# ============================================================================
# 参数:
#   $1 - 命令名称
# 返回:
#   0 存在, 1 不存在
# ----------------------------------------------------------------------------
dep_check_cmd() {
    local cmd="$1"
    command -v "$cmd" >/dev/null 2>&1
}

# ============================================================================
# 检查所有必需依赖
# ============================================================================
# 返回:
#   0 所有依赖都满足, 1 有缺失的依赖
# ----------------------------------------------------------------------------
dep_check_required() {
    local missing=()

    for tool in "${REQUIRED_TOOLS[@]}"; do
        if ! dep_check_cmd "$tool"; then
            missing+=("$tool")
        fi
    done

    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "缺少必需的依赖: ${missing[*]}"
        log_error "请安装缺失的依赖:"
        log_error "  macOS: brew install ${missing[*]}"
        log_error "  Linux: apt install ${missing[*]} (Ubuntu/Debian)"
        log_error "         yum install ${missing[*]} (CentOS/RHEL)"
        return 1
    fi

    return 0
}

# ============================================================================
# 检查可选依赖
# ============================================================================
# 返回:
#   缺失的可选依赖列表
# ----------------------------------------------------------------------------
dep_check_optional() {
    local missing=()

    for tool in "${OPTIONAL_TOOLS[@]}"; do
        if ! dep_check_cmd "$tool"; then
            missing+=("$tool")
        fi
    done

    if [[ ${#missing[@]} -gt 0 ]]; then
        log_warn "缺少可选依赖: ${missing[*]}"
        log_warn "某些功能可能不可用"
    fi

    echo "${missing[@]}"
}

# ============================================================================
# 检测操作系统类型
# ============================================================================
# 返回:
#   操作系统类型 (macos/linux/unknown)
# ----------------------------------------------------------------------------
dep_detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "linux"
    else
        echo "unknown"
    fi
}

# ============================================================================
# 检查 macOS 特定功能
# ============================================================================
# 返回:
#   0 支持, 1 不支持
# ----------------------------------------------------------------------------
dep_check_macos_features() {
    local os_type
    os_type="$(dep_detect_os)"

    if [[ "$os_type" != "macos" ]]; then
        return 1
    fi

    # 检查 caffeinate 是否可用
    if ! dep_check_cmd "caffeinate"; then
        log_warn "caffeinate 不可用，防睡眠功能将无法使用"
        return 1
    fi

    return 0
}

# ============================================================================
# 获取系统信息
# ============================================================================
# 输出系统信息到日志
# ----------------------------------------------------------------------------
dep_system_info() {
    local os_type
    os_type="$(dep_detect_os)"

    log_info "系统类型: $os_type"
    log_debug "BASH 版本: $BASH_VERSION"
    log_debug "操作系统: $OSTYPE"
}

# ============================================================================
# 自动安装提示
# ============================================================================
# 根据操作系统提供安装命令
# ----------------------------------------------------------------------------
dep_install_hint() {
    local tool="$1"
    local os_type
    os_type="$(dep_detect_os)"

    case "$os_type" in
        macos)
            echo "brew install $tool"
            ;;
        linux)
            echo "sudo apt install $tool  # Ubuntu/Debian"
            echo "sudo yum install $tool  # CentOS/RHEL"
            ;;
        *)
            echo "请手动安装 $tool"
            ;;
    esac
}
